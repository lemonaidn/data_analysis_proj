---
title: "Data Analysis Team 3 Notebook - POST CLEAN ANALYSIS ONLY"
author: "Aidan Hughes, Aya Hussein, Caley Fox Shannon"
date: "`r Sys.Date()`"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 

For our data analysis project, we have chosen to look at House of Representatives Office Expenditures. We think that the dataset is rich with newsworthy details and we know that the public is generally interested in how lawmakers spend our tax dollars.

## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}

# Turn off scientific notation. 

options(scipen=999)

# Load libraries. 

library(tidyverse)
library(readr)
library(scales)
library(janitor)

```

## Load and Cleaning Data. 

To run the full data clean, see the notebook "clean_only.rmd" For ease, this analysis will begin with a read in of the cleaned dataframes. 

```{r}

# Begin by reading in the four dataframes that were created in "clean_only.rmd" 

# Spend_with_member_info.csv is too large to push via GitHub, please see WeTransfer and drop into data folder for this repository on desktop. 

spend_with_member_info <- read_csv("data/spend_with_member_info.csv")

dmv_spend_with_member_info <- read_csv("data/dmv_spend_with_member_info.csv")

house_spend_18_22 <- read_csv("data/house_spend_18_22.csv")

totals_dmv_spend <- read_csv("data/totals_dmv_spend.csv")

```
## Do some basic aggregates to make sure that further cleaning isn't needed. 

```{r}

# Let's look at the spending categories (column is called purpose) to get a general sense of where reps are using their budgets. 

totals_dmv_spend_purpose <- totals_dmv_spend %>%
  group_by(purpose) %>%
  summarise(total_expenses = sum(amount)) %>%
  arrange(desc(total_expenses))

totals_dmv_spend_purpose 

# OFFICIAL EXPENSES OF MEMBER TOTALS sounds really vague, and it's the top category by far with a spend of $135,333,002.69. We also notice that Official Expenses of Members is one of the two options for the "program" column in totals_dmv_spend. That seems like a red flag. 

# The other value in the program column is INTERN ALLOWANCES. We have a column in totals_dmv_spend_purpose called INTERN ALLOWANCES TOTALS: as well, which totals $1,532,417.41

# Are these two values in the purpose category redundant? Let's save these numbers, then filter the two rows out and see if they equal the sum of all other purposes that remain. 

official <- 135333002.69
interns <- 1532417.41

totals_dmv_spend_purpose <- totals_dmv_spend %>%
  filter(purpose != "OFFICIAL EXPENSES OF MEMBERS TOTALS:")|> 
  filter(purpose != "INTERN ALLOWANCES TOTALS:")|> 
  group_by(purpose) %>%
  summarise(total_expenses = sum(amount)) %>%
  arrange(desc(total_expenses))

totals_dmv_spend_purpose 

# What's the sum of all of the remaining 9 categories? Does it equal the sum of OFFICIAL EXPENSES OF MEMBER TOTALS and INTERN ALLOWANCES? 

without_official_interns <- sum(totals_dmv_spend_purpose$total_expenses)
	
remainder <- (without_official_interns - official - interns)

remainder

# We have an extremely small decimal here that would have been rounded to zero for accounting purposes. So that appears to be a total redundancy after all. 

# Let's resave totals_dmv_spend so that we are permanently excluding these redundancies when working with that dataframe. 

totals_dmv_spend <- totals_dmv_spend %>%
  filter(purpose != "OFFICIAL EXPENSES OF MEMBERS TOTALS:")|> 
  filter(purpose != "INTERN ALLOWANCES TOTALS:")

# Just double checking that now we have only the appropriate 9 options for purpose. 

totals_dmv_spend_purpose <- totals_dmv_spend %>%
  group_by(purpose) %>%
  summarise(total_expenses = sum(amount)) %>%
  arrange(desc(total_expenses))

totals_dmv_spend_purpose 

# Let's get a percent of total column as well to get a sense of where reps are spending the most and least across the 9 categories. 

totals_dmv_spend_purpose <- totals_dmv_spend_purpose |> 
  mutate(pct_of_total = (total_expenses/(sum(total_expenses)))*100)

```


### Question 1

* **Question**: Do US reps from DC, Maryland and Virginia spend less on average than their colleagues? It seems logical that they would spend significantly less at least on travel, but is that the case? If so, does that mean they spend less overall, or do they outspend their peers in other categories?

* **Analysis summary**: Overall, reps spent an average of $1.2 to nearly $1.7 million each year. Their budgets steadily increased year over year between 2018 and 2022. 

We found that compared to the average in Congress, reps from the DMV spend $15,254.09 less each year. We also looked at their travel spending, and found that they spent on average $32,870.38 less annually per year. That means they probably outspend their peers in some other categories, but at least they spend less overall as we expected. 

So we looked at how DMV reps allocate their budget, by percent, compared to the national averages. And it turns out that they spend 2.5% more of their budget on compensation and almost half a percent more on rent, communication and utilities. It would be interesting to look at these numbers more closely. Do DMV reps pay for more office space near the capital, which we know to be higher than national averages? The same question goes for salary, do they have to pay staff more because so many live full time in the DMV where cost of living is high? In another analysis, it may be interesting to compare spending by DMV reps to those from other high cost-of-living areas like the Bay or NYC. 

```{r}

# We need to look at the overall house spend but first let's rid it of the redundancies we found above with Official Member Expenses and Intern Allowance.  

house_spend_18_22 <- house_spend_18_22 |> 
  filter(purpose != "OFFICIAL EXPENSES OF MEMBERS TOTALS:")|> 
  filter(purpose != "INTERN ALLOWANCES TOTALS:")

house_spend_18_22 
```


```{r}

# Calculate average spend for all members, not just those in the DMV. First, filter out non-member offices and committees to confirm that there are 435 unique members per year. 

house_spend_18_22 <- house_spend_18_22 %>%
  filter(!is.na(bioguide_id))

house_spend_18_22 %>%
  filter(office_year >= 2018) %>%
  group_by(office_year, bioguide_id) %>%
  summarise() %>%
  group_by(office_year) %>%
  summarise(count = n())

# Surprisingly, there are more than 435 members each year even after we've filtered out records without a bioguide_id and by the office_year (which is intended to avoid any confusion about offices changing hands in January). But we do know that sometimes reps pass away, are appointed to other positions, or leave their seats for other reasons and are replaced. So we'll need to divide by the numbers above to find our average rather than 435 for every year. 

house_spend_18_22_totals <- house_spend_18_22 %>%
  group_by(year) %>%
  summarise(annual_total = sum(amount)) %>%
  mutate(members_per_year = c(451, 447, 442, 451, 448)) %>%
  mutate(annual_avg_per_member = annual_total / members_per_year)

house_spend_18_22_totals 
  
```

```{r}
# Now do the same process for DMV reps. 

totals_dmv_spend %>%
  filter(office_year >= 2018) %>%
  group_by(office_year, bioguide_id) %>%
  summarise() %>%
  group_by(office_year) %>%
  summarise(count = n())

totals_dmv_spend_totals <- totals_dmv_spend %>%
  group_by(year) %>%
  summarise(dmv_annual_total = sum(amount)) %>%
  mutate(dmv_annual_avg_per_member = dmv_annual_total / 20)

totals_dmv_spend_totals

```

```{r}
# Now join to compare side by side. 

house_dmv_totals <- house_spend_18_22_totals |> 
  left_join(totals_dmv_spend_totals, join_by(year))

house_dmv_totals

house_dmv_totals <- house_dmv_totals |> 
  group_by(year, annual_avg_per_member, dmv_annual_avg_per_member)|> 
  summarise(difference = annual_avg_per_member - dmv_annual_avg_per_member)

average_total_difference <- mean(house_dmv_totals$difference)

average_total_difference 

# So on average, DMV reps spent less every year than the House as a whole did, on average $15,254.09 less per member each year. 
```


```{r}

# Now let's test the hypothesis that DMV reps probably spend less on transportation than other members do. 

house_spend_18_22_travel <- house_spend_18_22 %>%
  filter(purpose == "TRAVEL TOTALS:") %>%
  #need to group_by and calculate avgs per year so our avgs aren't skewed based on how many years a member has served
  group_by(year) %>%
  summarise(annual_total = sum(amount)) %>%
  mutate(members_per_year = c(451, 447, 442, 451, 448)) %>%
  mutate(annual_avg_per_member = annual_total / members_per_year)
  
house_spend_18_22_travel

dmv_spend_travel <- totals_dmv_spend %>%
  filter(purpose == "TRAVEL TOTALS:") %>%
  #need to group_by and calculate avgs per year so our avgs aren't skewed based on how many years a member has served
  group_by(year) %>%
  summarise(dmv_annual_total = sum(amount)) %>%
  mutate(dmv_annual_avg_per_member = dmv_annual_total / 20)

dmv_spend_travel

house_dmv_travel <- house_spend_18_22_travel |> 
  left_join(dmv_spend_travel, join_by(year))

house_dmv_travel

house_dmv_travel<- house_dmv_travel |> 
  group_by(year, annual_avg_per_member, dmv_annual_avg_per_member)|> 
  summarise(difference = annual_avg_per_member - dmv_annual_avg_per_member)

house_dmv_travel

average_difference <- mean(house_dmv_travel$difference)

average_difference

# Hypothesis confirmed that they spend substantially less on travel than other members, on average more $32,870.38 less annually per member. But they only spend ~$15.2K less than others overall, meaning that they are overspending somewhere else. 

```

```{r}
# Let's look at spending by category to figure out where DMV reps are actually outspending their colleagues. Because we already have totals_dmv_spend_purpose, we'll create an analogous df for the house to compare spending by percent allocation across the 9 categories.

house_spend_18_22_purpose <- house_spend_18_22 %>%
  group_by(purpose) %>%
  summarise(house_total_expenses = sum(amount)) %>%
  arrange(desc(house_total_expenses))|> 
  mutate(house_pct_of_total = (house_total_expenses/(sum(house_total_expenses)))*100)

totals_dmv_spend_purpose <- totals_dmv_spend_purpose |> 
  rename(dmv_total_expenses = total_expenses)|> 
  rename(dmv_pct_of_total = pct_of_total)

# Join to compare side by side.  

category_comparison <- house_spend_18_22_purpose |> 
  left_join(totals_dmv_spend_purpose, join_by(purpose))

# Add a column that shows the percent difference between DMV rep and overall rep spending across the categories. 

category_comparison <- category_comparison |> 
  mutate(dmv_difference = dmv_pct_of_total - house_pct_of_total)

```


### Question 2

* **Question**: Which political party in the DMV does the most spending, and does that change with whether or not that party holds the majority in the House?

* **Analysis summary**: When it comes to overall spending by party, Democratic reps from the DMV in the house are spending way more than Republicans. But that's because more of the 20 total reps are Democrats. In 2018 when Republicans held the majority, the DMV had 8 Republican reps. Since Democrats took the majority from 2019-2022, there have only been 5 Republicans representing the DMV. 

We need to look at average spending per member to get a more accurate picture of spending trends, and there we did not find a very strong correlation between a DMV rep's party and whether or not the party was in the majority. Republican reps from the DMV spent more on average than Democrats did in 2018 when they were in the majority, but they also spent more in 2020 and 2021 when they were not. Democratic reps from the DMV outspent DMV Republicans in 2019 and 2022. 

```{r}
# First we needed to do a little research about who controlled the House from 2018-2022. It was Republicans in 2018 and Democrats every other year, so we made a simple spreadsheet to import. 

house_majority <- read_csv("data/house_majority.csv")

# Join with the totals_dmv_spend dataframe 

totals_dmv_spend <- totals_dmv_spend |> 
  left_join(house_majority, join_by("office_year" == "year"))

totals_dmv_spend
```

```{r}
# Look at spending by party each year. 

totals_dmv_spend |>
  filter(office_year >= 2018)|> 
  group_by(office_year, party, majority_party)|> 
  summarise(party_spend = sum(amount))

# Clearly Democrats are way outspending Republicans overall. But is that just because there are most Democrats representing the DMV. We need to look at average spending per member. 

# To do that, we have to find the number of members each party had in the DMV each year. We know there are 20 seats total. This will allow us to calculate an average spend by party for each year. First, make a df with one row per member per year, along with their party

all_members_per_year <- totals_dmv_spend %>%
  filter(office_year >=2018)  %>%
  group_by(office_year,bioguide_id,party) %>%
  summarise()

all_members_per_year

# Calculate party members per year. 

members_grouped_per_year <- all_members_per_year %>%
  group_by(party, office_year) %>%
  summarise(party_members_per_year = n()) %>%
  arrange(office_year)

members_grouped_per_year

# Calculate how much each party spent per year. 

party_spending_annual <- totals_dmv_spend |>
  filter(office_year >=2018)  %>%
  group_by(party, office_year, majority_party)|>
  summarise(party_spend = sum(amount))|>
  arrange(desc(party_spend)) %>%
  arrange(office_year)

party_spending_annual
```

```{r}
# Join the dfs and calculate an average spend per member for each party per year.  

party_spending_w_rep_numbers <- party_spending_annual %>%
  left_join(members_grouped_per_year) %>%
  mutate(avg_spend_per_member = party_spend / party_members_per_year) %>%
  arrange(desc(avg_spend_per_member)) 

party_spending_w_rep_numbers|> 
  select(-party_spend, -party_members_per_year)|> 
  arrange(office_year)

```

### Question 3

* **Question**: Did the most common categories of spending change during COVID? For example, were members spending less on office equipment while everyone was working remotely? Or did they perhaps spend more on franked mail to communicate with constituents during isolation?

* **Analysis summary**: We found that during the height of the pandemic in 2020, DMV representatives spent way less on travel as well as rent, communication and utilities. Spending on supplies and materials peaked in 2020; we hypothesize that the switch to remote work could have necessitated more supplies for staffers. Franked mail was high in 2018, 2020 and 2022, which could be related to them being election years). Spending on printing and reproduction, as well as personnel compensation have all been rising every year. On the other had, spending on equipment has dropped dramatically.


```{r}
# Since there isn't a specific date column, we need to go by year. 2020 and 2021 were the main COVID years.

# We need to look at total spending of each category by year:

category_by_year <- totals_dmv_spend |> 
  filter(office_year >= 2018, office_year <= 2022)|> 
  group_by(office_year, purpose) |> 
  summarize(total_spend = sum(amount)) |> 
  drop_na()

category_by_year

# It's really hard to compare the amounts by just looking at the table. A visualization would greatly help with comparing the different categories:

category_by_year |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  facet_wrap(~purpose) +
  labs(x="Year",
       y="Amount Spent")

# Because personnel compensation is so much greater than all other categories, it's throwing off the scale of the visualization. Let's remove it and look at the other 8 categories side by side. 

category_by_year |> 
  filter(purpose != "PERSONNEL COMPENSATION TOTALS:")|> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  facet_wrap(~purpose) +
  labs(x="Year",
       y="Amount Spent")


# We can also look more closely at all of the 9 categories.

category_by_year |> 
  filter(purpose == "PERSONNEL COMPENSATION TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="PERSONNEL COMPENSATION",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "EQUIPMENT TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="EQUIPMENT",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "FRANKED MAIL TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="FRANKED MAIL",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "OTHER SERVICES TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="OTHER SERVICES",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "PRINTING AND REPRODUCTION TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="PRINTING AND REPRODUCTION",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "RENT  COMMUNICATION  UTILITIES TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="RENT COMMUNICATION UTILITIES",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "SUPPLIES AND MATERIALS TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="SUPPLIES AND MATERIALS",
       caption="source: ProPublica")

category_by_year |> 
  filter(purpose == "TRAVEL TOTALS:") |> 
  ggplot() +
  geom_line(aes(x=office_year, y=total_spend))+
  labs(x="Year",
       y="Amount Spent",
       title="TRAVEL",
       caption="source: ProPublica")


```

### Question 4

* **Question**: Let's get a sense of the high highs and low lows. What are the biggest expenses for DMV reps? Who is the most frugal spender? 

* **Analysis summary**: We know from totals_dmv_spend_purpose that personnel compensation makes up the lion's share (78%) of spending by Congress. The top expense from DMV Reps between 2018 and 2022 is from Elaine G. Luria, a Democrat from Virginia. In 2022, her staffers made at a total of $573,977.80. 

As for the lowest annual spender in the DMV, it appears at first blush to be Kweisi Mfume of Maryland, who spent $729,418.30 in 2020. That's basically a quarter million less than even the next lowest annual spend, which was Donald Beyer's $986,166.50 in 2018. But wait! A Google search tells us that Mfume was sworn in on May 5, 2020, after a special election for the seat of the late Rep. Elijah Cummings. So the honor in fact goes to Rep Don Beyer of Virginia after all. 

```{r}

# What are the top individual expenses from DMV reps, 2018-2022?

totals_dmv_spend |> 
  group_by(last_name, first_name, purpose, amount)|> 
  arrange(desc(amount))

```

## Which offices in the DMV are spending the least annually? There may be an interesting story behind lawmakers who have shown restraint in spending their budgets compared to colleagues.

```{r}

# Create a new column that sums an offices expenses into a total sum.  

spend_by_office <- totals_dmv_spend |> 
  filter(office_year >= 2018) |> 
  group_by(last_name, first_name, office_year)|> 
  summarise(office_total = sum(amount))

# Arrange to see which office spent the least over a year. 

spend_by_office |> 
   arrange(office_total)
 
```

### Question 5

* **Question**: Has staff pay kept on pace with wage growth nation-wide? The Federal Times has reported on this question, but we think it would be well-suited for data visualization.

```{r}

# If running "post-clean," read back in dmv_spend_with_member_info

dmv_spend_with_member_info <- read_csv("data/dmv_spend_with_member_info.csv")

# Look at employee compensation in the house for full-time staff. 

details_dmv_staff_pay <- dmv_spend_with_member_info %>%
  filter(category == "PERSONNEL COMPENSATION") %>%
  filter(office_year >= 2018) %>%
  # exclude interns, temporary and part-time employees, and total/subtotal rows 
  filter(program != "INTERN ALLOWANCES") %>%
  filter(purpose != "PERSONNEL COMPENSATION TOTALS:" & purpose != "TEMPORARY EMPLOYEE" & purpose != "PAID INTERN" & purpose != "PART-TIME EMPLOYEE (OTHER COMPENSATION)" & purpose != "PART-TIME EMPLOYEE (OTHER COMPENSATION)" & purpose != "PART-TIME EMPLOYEE" & purpose != "OFFICE TOTALS:" & purpose != "OFFICIAL EXPENSES OF MEMBERS TOTALS") %>%
  select(-organization_code, -program_code, -budget_object_class, -data_source, -document, -vendor_id, -budget_object_code, -transcode, -recordid, -id, -sort_subtotal_description, -transaction_date, -date)

details_dmv_staff_pay

```

Here's where we run into an issue: each of these rows might pertain to different lengths of time, making direct comparison of various amounts (or incorporation into a reliable average) a bit difficult. For example, there's a staff assistant's record that only pertains to 2022-05-02 through 2022-06-30, while other records pertain to the full Q2. This could be for a variety of reasons -- hires or resignations mid-quarter, staff moving from the "official" side to the "campaign" side during an election year, etc.

This is a significant limitation on our ability to easily answer this question using this data set that we didn't recognize earlier.

Although it's not a perfect solution, let's standardize the "amount" values by using the start date and end date of each expense to calculate how many days of a staffer's salary the expense covers. We'll then divide the "amount" col by that number of days, and then multiply it by 91.25 (365/4). These numbers won't be 100% accurate vs their real salaries, but should get us within spitting distance and serve as a pretty rough estimate of what their quarterly (and then annual) salary would be.

```{r}

details_dmv_staff_pay <- details_dmv_staff_pay %>%
  mutate(days_covered = as.numeric(difftime(end_date, start_date, units = "days"))+1) %>%
  mutate(est_quarterly_pay = amount / days_covered * 91.25) %>%
  mutate(est_annual_pay = est_quarterly_pay * 4)


details_dmv_staff_pay

```

Now let's calculate a per-role, per-year avg salary. NOTE: "Other compensation" records seem to be one-time additional payments (do congressional staffers earn bonuses?...) rather than a normal part of staffers' salaries so I'm excluding them. Same with overtime pay.

```{r}

cleaned_details_dmv_staff_pay <- details_dmv_staff_pay %>%
  filter(!str_detect(purpose, "OTHER COMPENSATION") & !str_detect(purpose, "OVERTIME")) %>%
  select(office_year, payee, purpose, est_annual_pay) %>%
  distinct() %>%
  group_by(office_year, purpose) %>%
  summarise(avg_salary = sum(est_annual_pay) / n()) %>%
  arrange(avg_salary)

cleaned_details_dmv_staff_pay

```

It's hard to identify which records or job titles are permanent staff positions vs temporary, contract, etc. expenses without manually checking each of the hundreds of grouped values in the "purpose" column, seeing which dates and frequencies they appear, and then using best judgement/assumptions to further standardize or filter. We weren't feeling confident in the likelihood that the results would be accurate due to all of the factors discussed above.

Let's select and plot just a few roles' averages against national wage growth data just for comparison's sake. However, note that these results are also fuzzy/difficult to use since some job titles suggest dual roles for certain staffers (for example, some schedulers might just be schedulers, while others are both schedulers/press assistant or schedulers/deputy comm dirs, etc.)

```{r}

# get a df with avg annual pay for leg aides, press secs, and schedulers (for job titles ONLY described as schedulers, none with dual roles)

cleaned_details_dmv_staff_pay <- cleaned_details_dmv_staff_pay %>%
  filter(purpose == "SCHEDULER" | purpose == "LEGISLATIVE AIDE" | purpose == "PRESS SECRETARY") %>%
  rename("job_title" = "purpose",
         "year" = "office_year") %>%
  arrange(year)

cleaned_details_dmv_staff_pay

```

```{r}
# update the national_wage df to allow for binding and plotting with the staff pay df from above

national_wages <- read_csv("data/national_average_wage_index.csv") |> clean_names() %>%
  rename("avg_salary" = "index") %>%
  mutate(job_title = "NATIONAL WAGES") %>%
  select(year, job_title, avg_salary) %>%
  filter(year >= 2018)

national_wages 
```

```{r}
wage_comparison_df <- rbind(cleaned_details_dmv_staff_pay, national_wages) %>%
  arrange(year)

wage_comparison_df
```

```{r}
ggplot(wage_comparison_df, aes(x = year, y = avg_salary, color = job_title)) +
  geom_line() +
  geom_point() +
  labs(title = "Leg. aide wages remain far behind national average",
       x = "Year",
       y = "Average Salary",
       color = "Job Title") +
  theme_minimal()
```

(I'll update "national_wages" later so it has a label that matches the format of the other job titles)

Let's try to switch gears and just look at a percent change in staff salaries year over year using subtotal records, and compare that to national trends in wage growth. However, the accuracy of those calculations would rely on a big assumption that the level of staffing has stayed constant and offices have not grown or shrunk year-to-year.

```{r}
# calculate annual % change in personnel expenditures for DMV reps

totals_dmv_spend_pct_change <- totals_dmv_spend %>%
  filter(purpose == "PERSONNEL COMPENSATION TOTALS:",
         program == "OFFICIAL EXPENSES OF MEMBERS") %>%
  group_by(year) %>%
  summarise(amount = sum(amount)) %>%
  # I got ChatGPT's help with this last step since I wasn't familiar with the "lag" function:
  mutate(pct_change = (amount - 18276024) / 18276024 * 100) %>%
  mutate(data_source = "Personnel Expenditure Subtotals")

totals_dmv_spend_pct_change
```

```{r}
# calculate annual % change in personnel expenditures for national wage avgs

national_wages_pct_change <- national_wages %>%
  mutate(pct_change = (avg_salary - 52145.80) / 52145.80 * 100) %>%
  mutate(data_source = "National Wage Avgs") %>%
  rename("amount" = "avg_salary") %>%
  select(-job_title)

national_wages_pct_change
```

```{r}
# bind the data

wage_comparison_pct_change_df <- rbind(totals_dmv_spend_pct_change, national_wages_pct_change) %>%
  arrange(year)

wage_comparison_pct_change_df
```
```{r}
# visualize

ggplot(wage_comparison_pct_change_df, aes(x = year, y = pct_change, color = data_source, group = data_source)) +
  geom_line() +
  geom_point() +
  labs(title = "Growth in House Staff Pay Outpaces National Trends",
       x = "Year",
       y = "Percent Change vs 2018",
       color = "") +
  theme_minimal()

# Display the plot
print(ggplot())
```

### Question 6: What's up with Intern Allowances? 

* **Question**: We excluded Intern Allowances very early in our analysis to only look at regular member expenses. So we decided to go back and take a look to see what patterns we could observe about intern pay. 

* **Analysis summary**: Through this analysis we found that the House had strict caps on intern pay. In 2019, it was $20K total; in 2020 & 2021, $25K; in 2022, $35K. 

Many reps appear to be maximizing this line item, which makes sense to us. We did find a curious outlier. In 2019, Rep. John Carter from Texas spent $29,813.33 on interns, above the apparent ceiling of $20K. We could not figure out why that may be with the information in the dataset, and think it could deserve a closer look via other reporting methods outside of R. 

Strangely, we didn't find any Intern Allowances for 2018 when searching by program == INTERN ALLOWANCES. That couldn't be right, so we searched by the purpose column instead and voilà. So the house must have made a change in FY19 around how intern expenses were categorized in these reports. Strangely, the amount that reps spend on interns in 2018 appeared to vary widely and one rep, Thomas Massie from Kentucky, spend upwards of $43K on interns that year. In 2018 a total of 11 reps sepnd over $20K on interns, which would become the spending apparent cap on intern pay in the following year. 

```{r}

intern_allowances <- house_spend_18_22 |> 
  filter(program== "INTERN ALLOWANCES") |> 
  filter(purpose == "INTERN ALLOWANCES TOTALS:") |> 
  select(-start_date, -end_date, -sort_sequence, -purpose, -year, -fiscal_year_or_legislative_year)

intern_allowances |> 
  group_by(bioguide_id, office_year) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

# Okay, it looks like in 2022, many offices were spending $35,000 on interns or just a little less. There must have been a cap. Let's look at 2021. 

intern_allowances |> 
  filter(office_year == 2021)|> 
  group_by(bioguide_id, office_year) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

# Here the cap appears to be $25,0000. Interesting, the limit must have changed. How about 2020? 

intern_allowances |> 
  filter(office_year == 2020)|> 
  group_by(bioguide_id, office_year) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

# Alright, that year seemed to also be a $25,0000 cap. How about 2019? 

intern_allowances |> 
  filter(office_year == 2019)|> 
  group_by(bioguide_id, office_year) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

# Huh. Jon Carter spent nearly $30,000 on interns in 2019, when everyone else was spending a maximum of $20,000. Let's look closer at Carter's intern spend in 2019. 

house_spend_18_22 |> 
  filter(office_year == 2019)|> 
  filter(bioguide_id == "C001051")|> 
  filter(purpose == "INTERN ALLOWANCES TOTALS:")

# Why does Carter have 2 entries for quarters 2, 3 & 4 in 2019? We need to so some digging by looking at the detail level of his intern expenditures in 2019

carter_19 <- spend_with_member_info |> 
  filter(bioguide_id == "C001051")|> 
  filter(sort_sequence == "DETAIL")|> 
  filter(program == "INTERN ALLOWANCES")|> 
  mutate(office_year = as.numeric(sub(".*?(\\d{4}).*", "\\1", office)))|> 
  filter(office_year == 2019)

total <- sum(carter_19$amount)
total

# Yeah, still getting almost $30K. And after manually scanning, it doesn't look like any of these expenses are duplicates. 

# Last but not least, let's look at 2018. 

intern_allowances |> 
  filter(office_year == 2018)|> 
  group_by(bioguide_id, office_year) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

# There are zero results for 2018! Were interns not paid in 2018? Very weird. Did something change that year about how the House tracked intern expenses? Let's look at the detail level from 2018. 

detail_18 <- spend_with_member_info |> 
  filter(sort_sequence == "DETAIL")|> 
  mutate(office_year = as.numeric(sub(".*?(\\d{4}).*", "\\1", office)))|> 
  filter(office_year == 2018)

interns_18 <- detail_18 |> 
  filter(str_detect(purpose, "INTERN"))

# AHA! Some shuffling of how intern expenses are categorized definitely happened in after 2018. Starting in 2019, there is  program called INTERN ALLOWANCES. But in 2018, the intern expenses can be found by using the purpose column instead. In 2018, the program column for rows with intern expenses may GENERAL EXPENDITURES, SALARIES OFFICERS & EMPLOYEES, and more. So that's fun. Let's try again to total intern expenses by House member using purpose instead of program. 

interns_18  |> 
  group_by(bioguide_id, first_name, last_name) |> 
  summarise(annual_intern_spend = sum(amount))|> 
  arrange(desc(annual_intern_spend))

massie_interns_18 <- interns_18  |> 
  filter(bioguide_id == "M001184")

massie_total_18 <- sum(massie_interns_18$amount)
massie_total_18

# Fascinating. Now we see that in 2018 reps such as Thomas Massie (R-KY) spent over $43K on interns. That's a lot higher! The House must have cracked down on paid intern spend after that year, it would be really interesting to figure out what happened. 

```


### Memo as of Saturday December 2nd. 

Hey Derek! We've been having a time with this data set. It is really complex, with a lot of columns that appear to say very similar things. We have had to do extensive cleaning and filtering beyond that to have a data set that is accurate enough to answer questions but small/concise enough to be manageable and run code quickly. We hit some real snags as well around trying to group by dates, since at a certain point it hit us that an office may change hands when a new rep is sworn in in late January. That lead to the creation of a column called office_year which was extracted from the name of the office, and we're using that value to determine the legislative year of the expense. Not all rows (eg the subtotal rows) have start and end date values populated which is why we couldn't extract year from those cols instead, and most years don't have a pre-defined leg year column already.

We're also struggling right now with figuring out the average compensation for congressional staffers. Not every staffer was paid throughout the duration of an office year. For example, there's a staff assistant's record that only pertains to 2022-05-02 through 2022-06-30, while other records pertain to a full quarter. This could be for a variety of reasons -- hires or resignations mid-quarter, staff moving from the "official" side to the "campaign" side during an election year, etc.

We tried to account for this by standardizing the "amount" values. We used the start date and end date of each expense to calculate how many days of a staffer's salary the expense covers. We then divided the "amount" col by that number of days, and then multiplied it by 91.25 (365/4). Those numbers won't be 100% accurate vs their real salaries, but we hoped would get us within spitting distance and serve as a pretty rough estimate of what their quarterly (and then annual) salary would be.

However, trying to calculate averages for staffers using detail-level data still presented several challenges. Chief among them: it's hard to identify which records or job titles are permanent staff positions vs temporary, contract, etc. expenses without manually checking each of the hundreds of grouped values in the "purpose" column, seeing which dates and frequencies they appear, and then using best judgement/assumptions to further standardize or filter. We weren't feeling confident in the likelihood that the results would be accurate due to all of the factors above.

As an alternate method, we thought about just looking at a percent change in staff salaries year over year and comparing that to national trends in wage growth. However, that would rely on a big assumption that the level of staffing has stayed constant and offices have not grown or shrunk year-to-year.

After doing further reading, even the Congressional Research Service has highlighted the difficulty and data concerns they ran into when trying to use publicly available data to perform similar calculations to ours. They ultimately had to rely on LegiStorm data, and even then listed quite a number of "data concerns" that likely affect the accuracy of their own findings. Here's the report: https://crsreports.congress.gov/product/pdf/R/R44323

Amidst all the chaos, we were still able to find out some pretty interesting trends. One is that when we were comparing spending among DMV representatives during COVID to other years, we found that travel went down, but supplies and materials increased. Printing and reproduction increased dramatically post-COVID, particularly in 2022, where there was a huge spike. We don't have complete 2023 data, but if we did, it would be interesting to see if that category is still rising at the same rate. Franked mail goes up and down every year, going up specifically in 2018, 2020 and 2022. We think this may have something to do with those being election years.

We were also shocked to see that Maryland Rep. Kweisi Mfume spent so little in 2020, with only $729,418.30 in 2020, however we came to find out that he was swore in in May as the replacement for Rep. Cummings who passed away the year before. So the actual lowest annual spender is Rep. Don Beyer with $986,166.50 in 2018.

Overall, this is a real pain to deal with. It's almost like Congress wants us to stay out of it! 